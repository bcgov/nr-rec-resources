#!/usr/bin/env node
/**
 * Run GuardDuty malware scan on S3 objects whose keys are listed in a file (one key per line).
 * Use the file produced by list-unscanned-s3-objects.ts with --output.
 *
 * Usage: npm run guardduty:scan -w ops -- --bucket BUCKET --keys-file FILE [--profile PROFILE] [--region REGION]
 */

import {
  GuardDutyClient,
  SendObjectMalwareScanCommand,
} from '@aws-sdk/client-guardduty';
import { createLogger } from '../logger';
import { parseArgs, readKeysFromFile, runWithFatalHandler } from './utils';

function createGuardDutyClient(
  profile?: string,
  region?: string,
): GuardDutyClient {
  if (profile) process.env.AWS_PROFILE = profile;
  const resolvedRegion = region ?? process.env.AWS_REGION ?? 'us-east-1';
  return new GuardDutyClient({ region: resolvedRegion });
}

async function main(): Promise<void> {
  const startMs = Date.now();
  const { bucket, keysFile, profile, region } = parseArgs({
    demandKeysFile: true,
  });
  const resolvedRegion = region ?? process.env.AWS_REGION ?? 'us-east-1';
  const logger = createLogger('scan', { bucket, region: resolvedRegion });
  const client = createGuardDutyClient(profile, region);

  const keys = await readKeysFromFile(keysFile!);
  if (keys.length === 0) {
    logger.warn('No keys found in keys file', { keysFile });
    process.exit(0);
  }

  logger.info('Scanning objects in bucket', {
    count: String(keys.length),
    bucket,
  });
  let failed = 0;
  for (let i = 0; i < keys.length; i++) {
    const key = keys[i];
    try {
      await client.send(
        new SendObjectMalwareScanCommand({
          S3Object: { Bucket: bucket, Key: key },
        }),
      );
      logger.info('Scanned object', {
        key,
        status: 'success',
        progress: `${i + 1}/${keys.length}`,
      });
    } catch (err) {
      failed++;
      logger.error('Scan failed for key', {
        key,
        status: 'failed',
        progress: `${i + 1}/${keys.length}`,
        error: String(err),
      });
    }
  }

  const success = keys.length - failed;
  const durationMs = Date.now() - startMs;
  logger.info('Scan complete', {
    success: String(success),
    failed: String(failed),
    durationMs: String(durationMs),
  });
  if (failed > 0) process.exit(1);
}

runWithFatalHandler('scan', main);
