name: FTA Migration

on:
  schedule: [cron: "0 3 * * *"] # Every day at 3 AM
  workflow_call:
    inputs:
      tag:
        description: 'The tag of the containers to deploy'
        required: false
        type: string

permissions:
  id-token: write # This is required for requesting the JWT
  contents: write # This is required for actions/checkout
  packages: write
  pull-requests: write

jobs:
  run-fta-migration:
    strategy:
      matrix:
        environment: [dev, test, prod]
    name: Run FTA ${{ matrix.app_env }} Migration
    uses: ./.github/workflows/.aws-deployer.yml
    with:
      app_env: ${{ matrix.environment }}
      environment_name: ${{ matrix.environment }}
      command: apply
      flyway_image: ghcr.io/bcgov/nr-rec-resources/migrations/fta:${{ inputs.tag || 'latest' }}
      working_directory: migration
      tag: ${{ inputs.tag || 'latest' }}
    secrets: inherit
